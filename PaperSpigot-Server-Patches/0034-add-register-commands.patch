From 04be353bec08a69c9e42b80355baebd450b7a5c1 Mon Sep 17 00:00:00 2001
From: IFleetwood <zuxirewind@gmail.com>
Date: Mon, 13 Jul 2020 19:21:39 +0200
Subject: [PATCH] add-register-commands


diff --git a/src/main/java/cc/kasumi/kspigot/KSpigotConfig.java b/src/main/java/cc/kasumi/kspigot/KSpigotConfig.java
index 06abaac0..177b1277 100644
--- a/src/main/java/cc/kasumi/kspigot/KSpigotConfig.java
+++ b/src/main/java/cc/kasumi/kspigot/KSpigotConfig.java
@@ -6,6 +6,7 @@ import org.bukkit.Bukkit;
 import org.bukkit.command.Command;
 import org.bukkit.configuration.InvalidConfigurationException;
 import org.bukkit.configuration.file.YamlConfiguration;
+import org.spigotmc.Metrics;
 
 import java.io.File;
 import java.io.IOException;
@@ -26,7 +27,9 @@ public class KSpigotConfig {
     /*========================================================================*/
     public static YamlConfiguration config;
     static int version;
+    static Map<String, Command> commands;
     /*========================================================================*/
+    private static Metrics metrics;
 
     public static void init(File configFile)
     {
@@ -45,11 +48,33 @@ public class KSpigotConfig {
         config.options().header( HEADER );
         config.options().copyDefaults( true );
 
+        commands = new HashMap<String, Command>();
+
         version = getInt( "config-version", 9 );
         set( "config-version", 9 );
         readConfig( KSpigotConfig.class, null );
     }
 
+    public static void registerCommands()
+    {
+        for ( Map.Entry<String, Command> entry : commands.entrySet() )
+        {
+            MinecraftServer.getServer().server.getCommandMap().register( entry.getKey(), "Spigot", entry.getValue() );
+        }
+
+        if ( metrics == null )
+        {
+            try
+            {
+                metrics = new Metrics();
+                metrics.start();
+            } catch ( IOException ex )
+            {
+                Bukkit.getServer().getLogger().log( Level.SEVERE, "Could not start metrics service", ex );
+            }
+        }
+    }
+
     static void readConfig(Class<?> clazz, Object instance)
     {
         for ( Method method : clazz.getDeclaredMethods() )
diff --git a/src/main/java/net/minecraft/server/DedicatedServer.java b/src/main/java/net/minecraft/server/DedicatedServer.java
index c9bc83c1..a1ae5e07 100644
--- a/src/main/java/net/minecraft/server/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/DedicatedServer.java
@@ -181,6 +181,9 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
             org.github.paperspigot.PaperSpigotConfig.init((File) options.valueOf("paper-settings"));
             org.github.paperspigot.PaperSpigotConfig.registerCommands();
             // PaperSpigot end
+            // kSpigot start
+            cc.kasumi.kspigot.KSpigotConfig.registerCommands();
+            // kSpigot end
 
             DedicatedServer.LOGGER.info("Generating keypair");
             this.a(MinecraftEncryption.b());
-- 
2.27.0.windows.1

